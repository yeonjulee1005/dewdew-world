---
interface Props {
  giscusCategory: string
  giscusCategoryId: string
}

const {
  giscusCategory,
  giscusCategoryId
} = Astro.props

const locale = Astro.currentLocale as string;

// 현재 페이지 경로에서 .mdx 확장자와 마지막 슬래시 제거
const currentPath = Astro.url.pathname.replace(/\.mdx/g, '').replace(/\/$/, '');

---

<giscus-widget
  repo="yeonjulee1005/dewdew-world"
  repoid="R_kgDOLF55BQ"
  category={giscusCategory}
  categoryid={giscusCategoryId}
  mapping="pathname"
  term={currentPath}
  strict="0"
  reactionsenabled="1"
  emitmetadata="1"
  inputposition="top"
  theme="light_protanopia"
  lang={locale}
  crossorigin="anonymous"
  async
  loading="eager"
  >
</giscus-widget>

<script>
  import 'giscus'
  
  // Giscus terminate 함수
  const terminateGiscus = () => {
    const giscusFrame = document.querySelector('iframe[src*="giscus.app"]') as HTMLIFrameElement;
    if (giscusFrame) {
      giscusFrame.remove();
      // console.log('Giscus terminated');
    }
    
    const giscusWidget = document.querySelector('giscus-widget');
    if (giscusWidget) {
      giscusWidget.remove();
      // console.log('Giscus widget removed');
    }
  };
  
  // Giscus term 업데이트 함수
  const updateGiscusTerm = () => {
    const currentPath = window.location.pathname.replace(/\.mdx/g, '').replace(/\/$/, '');
    const giscusWidget = document.querySelector('giscus-widget');
    const currentLocale = document.documentElement.lang || 'ko';
    const routePath = window.location.pathname.split('/').at(-1);

    if (giscusWidget) {
      giscusWidget.setAttribute('term', currentPath);
      if (routePath === 'guestbook') {
        giscusWidget.setAttribute('categoryid', 'DIC_kwDOLF55Bc4CcmYh');
        giscusWidget.setAttribute('category', 'Guestbook');
        // console.log('Giscus term 업데이트:', currentPath);
      } else {
        giscusWidget.setAttribute('categoryid', currentLocale === 'ko' ? 'DIC_kwDOLF55Bc4Ctnac' : 'DIC_kwDOLF55Bc4Ctnap');
        giscusWidget.setAttribute('category', currentLocale === 'ko' ? 'Tech Comment Korean' : 'Tech Comment English');
        // console.log('Giscus term 업데이트:', currentPath);
      }
      
      // iframe이 있다면 src도 업데이트
      setTimeout(() => {
        const giscusFrame = document.querySelector('iframe[src*="giscus.app"]') as HTMLIFrameElement;
        if (giscusFrame) {
          const currentSrc = giscusFrame.src;
          const newSrc = currentSrc.replace(/term=[^&]*/, `term=${encodeURIComponent(currentPath)}`);
          giscusFrame.src = newSrc;
          // console.log('Giscus iframe src 업데이트:', newSrc);
        }
      }, 1000);
    }
  };
  
  // 페이지 전환 직전에 Giscus terminate
  document.addEventListener('astro:before-preparation', () => {
    // console.log('페이지 전환 시작 - Giscus terminate');
    terminateGiscus();
  });
  
  // 페이지 로드 후 term 업데이트
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateGiscusTerm, 2000);
  });
  
  // astro:page-load 이벤트로도 업데이트
  document.addEventListener('astro:page-load', () => {
    setTimeout(updateGiscusTerm, 1000);
  });
</script>