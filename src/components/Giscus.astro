---
interface Props {
  giscusId: string
  giscusCategory: string
  giscusCategoryId: string
}

const {
  giscusId,
  giscusCategory,
  giscusCategoryId
} = Astro.props

const locale = Astro.currentLocale as string;

// ê°œë°œ í™˜ê²½ ê°ì§€
const isDev = import.meta.env.DEV;

// í˜„ì¬ í˜ì´ì§€ ê²½ë¡œì—ì„œ .mdx í™•ì¥ìì™€ ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ ì œê±°
const currentPath = Astro.url.pathname.replace(/\.mdx\/?/g, '/').replace(/\/$/, '');

---

{!isDev && (
  <giscus-widget
    is:inline
    id={giscusId}
    repo="yeonjulee1005/dewdew-world"
    repoid="R_kgDOLF55BQ"
    category={giscusCategory}
    categoryid={giscusCategoryId}
    mapping="url"
    term={currentPath}
    strict="1"
    reactionsenabled="1"
    emitmetadata="0"
    inputposition="top"
    theme="light_protanopia"
    lang={locale}
    loading="eager"
    crossorigin="anonymous"
    async
    >
  </giscus-widget>
)}

{isDev && (
  <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-500">
    <p class="text-2xl font-bold text-red-400">ğŸ’¬ ëŒ“ê¸€ ê¸°ëŠ¥</p>
    <p class="text-sm">ê°œë°œ í™˜ê²½ì—ì„œëŠ” ëŒ“ê¸€ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    <p class="text-xs">ë°°í¬ í›„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
  </div>
)}

<script is:inline>
  import 'giscus'
  
  // Giscus iframe URLì—ì„œ .mdx í™•ì¥ì ì œê±° (ê°•ì œ ì ìš©)
  const normalizeGiscusURL = () => {
    const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
    if (giscusFrame) {
      const iframe = giscusFrame as HTMLIFrameElement;
      const currentSrc = iframe.src;
      
      // iframe srcì—ì„œ .mdx í™•ì¥ì ì œê±° (ê°•ì œ)
      if (currentSrc.includes('.mdx')) {
        const normalizedSrc = currentSrc.replace(/\.mdx/g, '');
        console.log('Giscus URL ì •ê·œí™”:', currentSrc, 'â†’', normalizedSrc);
        iframe.src = normalizedSrc;
        
        // ì¶”ê°€ë¡œ iframe ë‚´ë¶€ì˜ URLë„ ì •ê·œí™”
        setTimeout(() => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
            if (iframeDoc) {
              const currentUrl = iframeDoc.location.href;
              if (currentUrl.includes('.mdx')) {
                const cleanUrl = currentUrl.replace(/\.mdx/g, '');
                iframeDoc.location.replace(cleanUrl);
              }
            }
          } catch (e) {
            // CORS ì˜¤ë¥˜ ë¬´ì‹œ
          }
        }, 1000);
      }
    } else {
      // Giscus iframeì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë‹¤ì‹œ ì‹œë„
      setTimeout(normalizeGiscusURL, 100);
    }
  };
  
  // í˜ì´ì§€ ë¡œë“œ í›„ Giscus URL ì •ê·œí™”
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(normalizeGiscusURL, 500);
  });
  
  // ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸ (ìµœëŒ€ 10ì´ˆ)
  let checkCount = 0;
  const maxChecks = 100; // 10ì´ˆ (100 * 100ms)
  
  const periodicCheck = () => {
    if (checkCount < maxChecks) {
      normalizeGiscusURL();
      checkCount++;
      setTimeout(periodicCheck, 100);
    }
  };
  
  periodicCheck();
</script>