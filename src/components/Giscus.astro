---
interface Props {
  giscusId: string
  giscusCategory: string
  giscusCategoryId: string
}

const {
  giscusId,
  giscusCategory,
  giscusCategoryId
} = Astro.props

const locale = Astro.currentLocale as string;

// 개발 환경 감지
const isDev = import.meta.env.DEV;

---

{!isDev && (
  <giscus-widget
    is:inline
    id={giscusId}
    repo="yeonjulee1005/dewdew-world"
    repoid="R_kgDOLF55BQ"
    category={giscusCategory}
    categoryid={giscusCategoryId}
    mapping="pathname"
    term={giscusCategory}
    strict="1"
    reactionsenabled="1"
    emitmetadata="0"
    inputposition="top"
    theme="light_protanopia"
    lang={locale}
    loading="eager"
    crossorigin="anonymous"
    async
    >
  </giscus-widget>
)}

{isDev && (
  <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center text-gray-500">
    <p class="text-2xl font-bold text-red-400">💬 댓글 기능</p>
    <p class="text-sm">개발 환경에서는 댓글이 표시되지 않습니다.</p>
    <p class="text-xs">배포 후 확인해주세요.</p>
  </div>
)}

<script>
  import 'giscus'
  
  // Giscus 로드 전에 URL 정규화 (.mdx 확장자 제거)
  const normalizeURL = () => {
    const originalURL = window.location.href;
    
    // .mdx 확장자가 포함된 URL인지 확인하고 제거
    if (originalURL.includes('.mdx')) {
      const cleanURL = originalURL.replace(/\.mdx\/?/g, '/');
      window.history.replaceState({}, '', cleanURL);
    }
  };

  // 즉시 URL 정규화 실행
  normalizeURL();
  
  // Giscus가 로드된 후에도 URL 확인 및 수정
  const checkGiscusURL = () => {
    const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
    if (giscusFrame) {
      const iframe = giscusFrame as HTMLIFrameElement;
      const currentSrc = iframe.src;
      
      // iframe src에서 URL 정규화 (.mdx 확장자 제거)
      if (currentSrc.includes('.mdx')) {
        const normalizedSrc = currentSrc.replace(/\.mdx\/?/g, '/');
        iframe.src = normalizedSrc;
      }
    } else {
      // Giscus iframe이 아직 로드되지 않았다면 다시 시도
      setTimeout(checkGiscusURL, 100);
    }
  };
  
  // 페이지 로드 후 Giscus URL 확인
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(checkGiscusURL, 500);
  });
  
  // 추가적으로 주기적으로 확인 (최대 10초)
  let checkCount = 0;
  const maxChecks = 100; // 10초 (100 * 100ms)
  
  const periodicCheck = () => {
    if (checkCount < maxChecks) {
      checkGiscusURL();
      checkCount++;
      setTimeout(periodicCheck, 100);
    }
  };
  
  periodicCheck();
</script>