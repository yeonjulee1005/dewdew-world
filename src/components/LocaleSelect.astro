---
// Select UI to switch between locales.
import { getLocalePaths, LOCALES } from "../i18n";
---

<label>
  <span class="material-icons-sharp">translate</span>
  <select id="localeSelect" data-languageSelect>
    {
      getLocalePaths(Astro.url).map(({ path, lang }) => (
        <option
          label={LOCALES[lang].label}
          value={path}
          data-lang={lang}
          selected={lang === Astro.currentLocale}
          dir={LOCALES[lang].dir || null}
        />
      ))
    }
  </select>
  <span class="material-icons-sharp">expand_more</span>
</label>

<script>
function initializeLocaleSelect() {
  const localeSelect = document.getElementById("localeSelect") as HTMLSelectElement;
  
  if (!localeSelect) {
    return
  };

  // 기존 이벤트 리스너 제거 (중복 방지)
  localeSelect.removeEventListener("change", handleLanguageChange);
  // 새 이벤트 리스너 추가
  localeSelect.addEventListener("change", handleLanguageChange);
}

function handleLanguageChange(event: Event) {
  const target = event.target as HTMLSelectElement;

  if (target.value !== window.location.pathname) {
    window.location.href = target.value;
  }
}

// 초기 실행
initializeLocaleSelect();

// View Transitions 완료 후 재초기화
document.addEventListener('astro:page-load', () => {
  // console.log('Page loaded, reinitializing LocaleSelect');
  initializeLocaleSelect();
});

// DOMContentLoaded 이벤트도 추가 (백업)
document.addEventListener('DOMContentLoaded', () => {
  // console.log('DOMContentLoaded, initializing LocaleSelect');
  initializeLocaleSelect();
});
</script>

<style lang="scss" scoped>
  label {
    position: relative;
    display: inline-block;
    width: 126px;
    font-size: 16px;
    .material-icons-sharp {
      font-size: 12px;
      pointer-events: none;
      position: absolute;
      color: #f87171;
      &:first-child {
        font-size: 24px;
        inset: 8px auto 8px 8px;
        opacity: 0.4;
      }
      &:last-child {
        font-size: 28px;
        inset: 6px 6px 6px auto;
      }
    }
  }
  select {
    width: 100%;
    height: 38px;
    padding-left: 34px;
    padding-right: 34px;
    cursor: pointer;
    appearance: none;
    border-radius: 6px;
    color: #f87171;
    background-color: #ffffff;
    border: 2px solid #f87171;
    text-align: left;
    &:focus {
      border: 2px solid #f87171;
    }
  }
</style>